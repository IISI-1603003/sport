import{S as me,H as S,R as Ae,T as Re,Y as Pe,Z as ve,as as Ne,at as se,e as g,au as ze,U as $e,N as je,a3 as Me,av as Ee,aw as oe,ax as re,d as r,E as q,a4 as Le,ay as Oe,az as Ue,b as v,F as R,aA as Ye,ap as Ge,J as He,Q as Qe,aB as We,f as Xe,a as I,w as i,u as m,r as ie,q as J,aC as K,o as C,p as E,m as w,z as x,aD as qe,V as Je,j as Ke,y as Z}from"./index-mfJgyZhT.js";import{_ as Ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as et,a as tt}from"./VRow-Ds-4XX6a.js";import{V as ue}from"./VDialog-CWMt3jMY.js";import{V as lt}from"./VSnackbar-CYkhAcvC.js";import{V as ce,a as de,b as ee,c as fe}from"./VCard-C1ZeJHUw.js";import{V as pe}from"./VSpacer-BxK0GlpL.js";/* empty css              */import"./layout-DtmpDlug.js";function at(){function e(d){return[...d.dataTransfer?.items??[]].filter(n=>n.kind==="file").map(n=>n.webkitGetAsEntry()).filter(Boolean).length>0||[...d.dataTransfer?.files??[]].length>0}async function f(d){const u=[],n=[...d.dataTransfer?.items??[]].filter(s=>s.kind==="file").map(s=>s.webkitGetAsEntry()).filter(Boolean);if(n.length)for(const s of n){const h=await ye(s,ge(".",s));u.push(...h.map(c=>c.file))}else u.push(...d.dataTransfer?.files??[]);return u}return{handleDrop:f,hasFilesOrFolders:e}}function ye(e){let f=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";return new Promise((d,u)=>{e.isFile?e.file(s=>d([{file:s,path:f}]),u):e.isDirectory&&e.createReader().readEntries(async s=>{const h=[];for(const c of s)h.push(...await ye(c,ge(f,c)));d(h)})})}function ge(e,f){return f.isDirectory?`${e}/${f.name}`:e}const nt=me({filterByType:String},"file-accept");function st(e){const f=S(()=>e.filterByType?ot(e.filterByType):null);function d(u){if(f.value){const n=u.filter(f.value);return{accepted:n,rejected:u.filter(s=>!n.includes(s))}}return{accepted:u,rejected:[]}}return{filterAccepted:d}}function ot(e){const f=e.split(",").map(s=>s.trim().toLowerCase()),d=f.filter(s=>s.startsWith(".")),u=f.filter(s=>s.endsWith("/*")),n=f.filter(s=>!d.includes(s)&&!u.includes(s));return s=>{const h=s.name.split(".").at(-1)?.toLowerCase()??"",c=s.type.split("/").at(0)?.toLowerCase()??"";return n.includes(s.type)||d.includes(`.${h}`)||u.includes(`${c}/*`)}}const rt=me({chips:Boolean,counter:Boolean,counterSizeString:{type:String,default:"$vuetify.fileInput.counterSize"},counterString:{type:String,default:"$vuetify.fileInput.counter"},hideInput:Boolean,multiple:Boolean,showSize:{type:[Boolean,Number,String],default:!1,validator:e=>typeof e=="boolean"||[1e3,1024].includes(Number(e))},truncateLength:{type:[Number,String],default:22},...Ue({prependIcon:"$file"}),modelValue:{type:[Array,Object],default:e=>e.multiple?[]:null,validator:e=>ve(e).every(f=>f!=null&&typeof f=="object")},...nt(),...Oe({clearable:!0})},"VFileInput"),it=Ae()({name:"VFileInput",inheritAttrs:!1,props:rt(),emits:{"click:control":e=>!0,"mousedown:control":e=>!0,"update:focused":e=>!0,"update:modelValue":e=>!0,rejected:e=>!0},setup(e,f){let{attrs:d,emit:u,slots:n}=f;const{t:s}=Re(),{filterAccepted:h}=st(e),c=Pe(e,"modelValue",e.modelValue,t=>ve(t),t=>!e.multiple&&Array.isArray(t)?t[0]:t),{isFocused:b,focus:L,blur:P}=Ne(e),O=S(()=>typeof e.showSize!="boolean"?e.showSize:void 0),U=S(()=>(c.value??[]).reduce((t,p)=>{let{size:_=0}=p;return t+_},0)),T=S(()=>se(U.value,O.value)),N=S(()=>(c.value??[]).map(t=>{const{name:p="",size:_=0}=t,A=j(p);return e.showSize?`${A} (${se(_,O.value)})`:A})),Y=S(()=>{const t=c.value?.length??0;return e.showSize?s(e.counterSizeString,t,T.value):s(e.counterString,t)}),G=g(),z=g(),y=g(),H=ze(()=>b.value||e.active),a=S(()=>["plain","underlined"].includes(e.variant)),l=$e(!1),{handleDrop:F,hasFilesOrFolders:$}=at();function o(){y.value!==document.activeElement&&y.value?.focus(),b.value||L()}function k(t){y.value?.click()}function V(t){u("mousedown:control",t)}function D(t){y.value?.click(),u("click:control",t)}function B(t){t.stopPropagation(),o(),Qe(()=>{c.value=[],We(e["onClick:clear"],t)})}function j(t){if(t.length<Number(e.truncateLength))return t;const p=Math.floor((Number(e.truncateLength)-1)/2);return`${t.slice(0,p)}…${t.slice(t.length-p)}`}function he(t){t.preventDefault(),t.stopImmediatePropagation(),l.value=!0}function we(t){t.preventDefault(),l.value=!1}async function be(t){if(t.preventDefault(),t.stopImmediatePropagation(),l.value=!1,!y.value||!$(t))return;const p=await F(t);te(p)}function ke(t){if(!(!t.target||t.repack))if(e.filterByType)te([...t.target.files]);else{const p=t.target;c.value=[...p.files??[]]}}function te(t){const p=new DataTransfer,{accepted:_,rejected:A}=h(t);A.length&&u("rejected",A);for(const W of _)p.items.add(W);y.value.files=p.files,c.value=[...p.files];const Q=new Event("change",{bubbles:!0});Q.repack=!0,y.value.dispatchEvent(Q)}return je(c,t=>{(!Array.isArray(t)||!t.length)&&y.value&&(y.value.value="")}),Me(()=>{const t=!!(n.counter||e.counter),p=!!(t||n.details),[_,A]=Ee(d),{modelValue:Q,...W}=oe.filterProps(e),Ve={...re.filterProps(e),"onClick:clear":B},Ce=d.webkitdirectory!==void 0&&d.webkitdirectory!==!1,xe=d.accept?String(d.accept):void 0,Fe=Ce?void 0:e.filterByType??xe;return r(oe,q({ref:G,modelValue:e.multiple?c.value:c.value[0],class:["v-file-input",{"v-file-input--chips":!!e.chips,"v-file-input--dragging":l.value,"v-file-input--hide":e.hideInput,"v-input--plain-underlined":a.value},e.class],style:e.style,"onClick:prepend":k},_,W,{centerAffix:!a.value,focused:b.value}),{...n,default:X=>{let{id:De,isDisabled:le,isDirty:ae,isReadonly:ne,isValid:Ie,hasDetails:Se}=X;return r(re,q({ref:z,prependIcon:e.prependIcon,onMousedown:V,onClick:D,"onClick:prependInner":e["onClick:prependInner"],"onClick:appendInner":e["onClick:appendInner"]},Ve,{id:De.value,active:H.value||ae.value,dirty:ae.value||e.dirty,disabled:le.value,focused:b.value,details:Se.value,error:Ie.value===!1,onDragover:he,onDrop:be}),{...n,default:Te=>{let{props:{class:Be,..._e}}=Te;return v(R,null,[v("input",q({ref:y,type:"file",accept:Fe,readonly:ne.value,disabled:le.value,multiple:e.multiple,name:e.name,onClick:M=>{M.stopPropagation(),ne.value&&M.preventDefault(),o()},onChange:ke,onDragleave:we,onFocus:o,onBlur:P},_e,A),null),v("div",{class:Ge(Be)},[!!c.value?.length&&!e.hideInput&&(n.selection?n.selection({fileNames:N.value,totalBytes:U.value,totalBytesReadable:T.value}):e.chips?N.value.map(M=>r(He,{key:M,size:"small",text:M},null)):N.value.join(", "))])])}})},details:p?X=>v(R,null,[n.details?.(X),t&&v(R,null,[v("span",null,null),r(Ye,{active:!!c.value?.length,value:Y.value,disabled:e.disabled},n.counter)])]):void 0})}),Le({},G,z,y)}}),ut={class:"d-flex align-center"},ct=["onClick"],dt={class:"text-red mt-2"},ft={key:1,class:"text-grey"},pt={style:{"white-space":"pre-wrap"}},mt={__name:"fileList",setup(e){const f=g([]),d=g(!1),u=g(!1),n=g([]),s=g(!1),h=g(""),c=g({show:!1,message:"",color:"success"}),b=g(!1),L=g(""),P=g([]),O=[{title:"序號",key:"id",sortable:!0,width:"100px"},{title:"檔案",key:"name",sortable:!0},{title:"處理狀態",key:"status",sortable:!0,width:"140px"},{title:"上傳時間",key:"updateTime",sortable:!0,width:"180px"}],U=S(()=>f.value),T=(a,l="success")=>{c.value={show:!0,message:a,color:l}},N=async()=>{if(h.value="",!n.value||n.value.length===0){T("請選擇要上傳的檔案","warning");return}let a=n.value[0];s.value=!0;try{await K.uploadFile(a),u.value=!1,n.value=[],T("上傳成功"),setTimeout(async()=>{await Y()},1e3)}catch(l){console.error("上傳檔案失敗:",l);const F=l.response?.data?.message||"上傳檔案失敗";h.value=F,n.value=[]}finally{s.value=!1}},Y=async()=>{d.value=!0;try{const a=await K.getFiles();f.value=a.data}catch(a){console.error("載入檔案清單失敗:",a),T(message,"error")}finally{d.value=!1}},G=async a=>{try{const $=(await K.getFile(a.name)).data.split(`\r
`).map(o=>{const k=[];let V="",D=!1;for(let B=0;B<o.length;B++){const j=o[B];j==='"'?D&&o[B+1]==='"'?(V+='"',B++):D=!D:j===","&&!D?(k.push(V),V=""):V+=j}return k.push(V),k});P.value=$,L.value=a.name,b.value=!0}catch(l){console.log(l),T("檔案預覽失敗","error")}};function z(a){if(!a)return"";const l=a.indexOf("-");if(l===-1)return a;const F=a.lastIndexOf(".");return a.substring(0,l)+a.substring(F)}const y=()=>{const a=document.createElement("a");a.href="/files/templateSweatNa.xlsx",a.download="templateSweatNa.xlsx",document.body.appendChild(a),a.click(),document.body.removeChild(a)},H=a=>{switch(a){case"0":return"待處理";case"1":return"處理完成";case"2":return"處理失敗";default:return a}};return Xe(()=>{Y()}),(a,l)=>{const F=ie("l-data-table"),$=ie("LDataTable");return C(),I(R,null,[r(et,null,{default:i(()=>[r(tt,{cols:"12",class:"d-flex justify-end mb-2"},{default:i(()=>[r(E,{color:"success","prepend-icon":"mdi-plus",class:"mx-2",onClick:l[0]||(l[0]=o=>u.value=!0)},{default:i(()=>[...l[7]||(l[7]=[w(" 上傳 ",-1)])]),_:1}),r(E,{color:"primary","prepend-icon":"mdi-file-excel",onClick:y},{default:i(()=>[...l[8]||(l[8]=[w(" 範例下載 ",-1)])]),_:1})]),_:1})]),_:1}),r(F,{headers:O,items:m(U),loading:m(d)},{"item.id":i(({index:o})=>[w(x(o+1),1)]),"item.name":i(({item:o})=>[v("div",ut,[r(Je,{class:"me-2",color:"primary"},{default:i(()=>[...l[9]||(l[9]=[w(" mdi-file ",-1)])]),_:1}),v("span",{class:"text-primary cursor-pointer border-b border-primary",onClick:k=>G(o)},x(z(o.name)),9,ct)])]),"item.status":i(({item:o})=>[w(x(H(o.status)),1)]),"item.updateTime":i(({item:o})=>[w(x(("dayjs"in a?a.dayjs:m(qe))(o.updateTime).format("YYYY-MM-DD HH:mm")),1)]),_:1},8,["items","loading"]),r(ue,{modelValue:m(u),"onUpdate:modelValue":l[3]||(l[3]=o=>J(u)?u.value=o:null),"max-width":"600px"},{default:i(()=>[r(ce,null,{default:i(()=>[r(de,null,{default:i(()=>[...l[10]||(l[10]=[w("上傳檔案",-1)])]),_:1}),r(ee,null,{default:i(()=>[r(it,{modelValue:m(n),"onUpdate:modelValue":l[1]||(l[1]=o=>J(n)?n.value=o:null),label:"選擇xlsx檔案",multiple:"",variant:"outlined",accept:".xlsx","hide-details":"","prepend-icon":"mdi-paperclip"},null,8,["modelValue"])]),_:1}),r(ee,null,{default:i(()=>[l[11]||(l[11]=v("ul",{class:"pl-8"},[v("li",null,"檔案上限20MB"),v("li",null,"上傳的檔案註記八碼日期(ex:心理測驗_20230101.xlsx)")],-1)),v("pre",dt,x(m(h)),1)]),_:1}),r(fe,null,{default:i(()=>[r(pe),r(E,{border:"","prepend-icon":"mdi-plus",onClick:l[2]||(l[2]=o=>{u.value=!1,n.value=[]})},{default:i(()=>[...l[12]||(l[12]=[w("取消",-1)])]),_:1}),r(E,{border:"",color:"primary",class:"bg-blue",loading:m(s),onClick:N},{default:i(()=>[...l[13]||(l[13]=[w("上傳",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),r(ue,{modelValue:m(b),"onUpdate:modelValue":l[5]||(l[5]=o=>J(b)?b.value=o:null),"max-width":"1100px"},{default:i(()=>[r(ce,null,{default:i(()=>[r(de,null,{default:i(()=>[w(x(z(m(L))),1)]),_:1}),r(ee,null,{default:i(()=>[m(P).length?(C(),Ke($,{key:0},{default:i(()=>[v("thead",null,[v("tr",null,[(C(!0),I(R,null,Z(m(P)[0],(o,k)=>(C(),I("th",{key:k},x(o),1))),128))])]),v("tbody",null,[(C(!0),I(R,null,Z(m(P).slice(1),(o,k)=>(C(),I("tr",{key:k},[(C(!0),I(R,null,Z(o,(V,D)=>(C(),I("td",{key:D},x(V),1))),128))]))),128))])]),_:1})):(C(),I("div",ft,"無資料"))]),_:1}),r(fe,null,{default:i(()=>[r(pe),r(E,{color:"warning",text:"",onClick:l[4]||(l[4]=o=>b.value=!1)},{default:i(()=>[...l[14]||(l[14]=[w("關閉",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),r(lt,{modelValue:m(c).show,"onUpdate:modelValue":l[6]||(l[6]=o=>m(c).show=o),color:m(c).color,timeout:8e3},{default:i(()=>[v("div",pt,x(m(c).message),1)]),_:1},8,["modelValue","color"])],64)}}},xt=Ze(mt,[["__scopeId","data-v-b01427c3"]]);export{xt as default};
