import{f as u,h as C,L as c,b as k,o as j,M as T,j as F,w as i,e as l,k as I,m as V,t as S,N as B,n as y,F as E,I as O,s as P,u as A,O as M}from"./index-DsLPX3BI.js";import{V as N}from"./VForm-DeEXvWx8.js";import{V as x,a as U,b as q,c as D,d as b}from"./VCard-CL4EWFtp.js";import{V as w}from"./VSpacer-C1XAD_mX.js";import{V as L}from"./VDialog-nugxKd2C.js";import{r as z}from"./rules-CItqinxz.js";import{V as G}from"./VToolbar-CbjKb_2W.js";/* empty css              */const H={__name:"tree",emits:["edit"],setup(g,{expose:m,emit:p}){const f=p,r=u(),o=d=>f("edit",d),_=(d,s)=>{let e=$(r.value).jstree(!0),t=e.get_node(d);e.set_text(t,s)};return C(()=>{c.get().then(d=>{$(r.value).jstree({core:{data:d.data,check_callback(s,e,t,n,a){if(s==="delete_node")return confirm("確定要刪除嗎？");if(s==="move_node"&&!a.dnd)return confirm("確定要移動嗎？")},themes:{name:"default"}},plugins:["types","contextmenu","dnd"],types:{"#":{valid_children:["root"]},root:{valid_children:["role"]},role:{valid_children:["role"],icon:"mdi mdi-account-group text-warning"}},contextmenu:{items:function(s){var e=$.jstree.defaults.contextmenu.items();return e.create.label="新增",e.rename.label="重新命名",e.remove.label="移除",e.create.action=t=>{var n=$.jstree.reference(t.reference),a=n.get_node(t.reference);n.create_node(a,{type:"role"},"last")},e.edit={label:"設定",separator_before:!0,action(t){var n=$.jstree.reference(t.reference),a=n.get_node(t.reference);o(a.id)}},this.get_type(s)==="root"&&(delete e.rename,delete e.remove,delete e.edit),delete e.ccp,e}}}).on("create_node.jstree",(s,e)=>{let t=e.instance.get_node(e.node.parent);c.save({name:e.node.text,parentId:t.original.id,sequence:e.position}).then(n=>{e.node.original.id=n.data.id,e.instance.set_id(e.node,n.data.id),e.instance.edit(e.node)})}).on("rename_node.jstree",(s,e)=>{c.rename({id:e.node.id},{name:e.text})}).on("delete_node.jstree",(s,e)=>{c.delete({id:e.node.id})}).on("move_node.jstree",function(s,e){var t=e.instance.get_node(e.parent),n=e.instance.get_node(e.old_parent);c.move({id:e.node.id,parentId:t.original.id,position:e.position,oldParentId:n.original.id,oldPosition:e.old_position})})})}),m({rename:_}),(d,s)=>(j(),k("div",{ref_key:"root",ref:r},null,512))}},J={__name:"functions",emits:["change"],setup(g,{expose:m,emit:p}){const f=p,r=u([]),o=u(),_=()=>{$(o.value).jstree("close_all"),$(o.value).jstree("deselect_all")},d=e=>r.value=e,s=e=>{let t=[],n=[],a=[],h=[];e.forEach(v=>{switch(v.type){case"menu":t.push(v.id);break;case"page":n.push(v.id);break;case"operation":a.push(v.id);break;case"api":h.push(v.id);break}}),f("change",{menus:t,pages:n,operations:a,apis:h})};return C(()=>{c.functions().then(e=>{$(o.value).jstree({plugins:["types","checkbox"],core:{data:e.data,themes:{name:"default"}},sort:function(t,n){let a={menu:1,page:2,api:3};return a[this.get_type(t)]>a[this.get_type(n)]?1:-1},types:{"#":{valid_children:["menu"]},menu:{valid_children:["menu","page"],icon:"mdi mdi-folder text-warning"},page:{valid_children:["page","operation","api"],icon:"mdi mdi-file text-primary"},operation:{valid_children:["api"],icon:"mdi mdi-cog text-success"},api:{valid_children:[],icon:"mdi mdi-link text-red"}}}).on("ready.jstree",(t,n)=>{let a=n.instance.get_checked(!0);s(a);let h=$(o.value).jstree(!0);r.value.forEach(v=>{h.select_node(v)})}).on("select_node.jstree deselect_node.jstree",(t,n)=>{let a=n.instance.get_checked(!0);s(a)})})}),m({deselectAll:_,selection:d}),(e,t)=>(j(),k("div",{ref_key:"root",ref:o},null,512))}},K={__name:"popup",props:["title"],emits:["submit"],setup(g,{expose:m,emit:p}){const f=p,r=u(!1),o=u(null),_=()=>r.value=!0,d=()=>r.value=!1,s=()=>{o.value&&f("submit")};return T(o,e=>f("update:valid",e)),m({show:_,hide:d}),(e,t)=>(j(),F(L,{modelValue:r.value,"onUpdate:modelValue":t[2]||(t[2]=n=>r.value=n),width:"600",persistent:"",scrollable:""},{default:i(()=>[l(N,{onSubmit:I(s,["prevent"]),modelValue:o.value,"onUpdate:modelValue":t[1]||(t[1]=n=>o.value=n)},{default:i(()=>[l(x,{"max-height":"90vh"},{default:i(()=>[l(U,null,{default:i(()=>[V(S(g.title),1)]),_:1}),l(q,null,{default:i(()=>[B(e.$slots,"default")]),_:3}),l(D,null,{default:i(()=>[l(w),l(y,{type:"submit",color:"primary"},{default:i(()=>[...t[3]||(t[3]=[V("確定",-1)])]),_:1}),l(y,{onClick:t[0]||(t[0]=n=>r.value=!1)},{default:i(()=>[...t[4]||(t[4]=[V("取消",-1)])]),_:1}),l(w)]),_:1})]),_:3})]),_:3},8,["modelValue"])]),_:3},8,["modelValue"]))}},ne={__name:"index",setup(g){const m=u(null),p=u(null),f=u(null),r=O("menu"),o=u({id:null,name:null}),_=u({menus:[],pages:[],operations:[],apis:[]}),d=t=>{Promise.all([c.get({id:t}),c.functions({id:t})]).then(([n,a])=>{Object.assign(o.value,n.data),Object.assign(_.value,a.data),m.value.show(),setTimeout(()=>{p.value.deselectAll(),p.value.selection([...a.data.menus,...a.data.pages,...a.data.operations,...a.data.apis])})})},s=()=>{c.update({id:o.value.id},o.value).then(()=>{c.updateFunctions({id:o.value.id},_.value).then(()=>{m.value.hide(),f.value.rename(o.value.id,o.value.name),r.value.load(!0)})})},e=t=>{Object.assign(_.value,t)};return(t,n)=>(j(),k(E,null,[l(x,null,{default:i(()=>[l(G,{title:t.$root.subTitle},null,8,["title"]),l(b,null,{default:i(()=>[l(H,{ref_key:"tree",ref:f,onEdit:d},null,512)]),_:1})]),_:1}),l(K,{ref_key:"popup",ref:m,title:"角色設定",onSubmit:s},{default:i(()=>[l(P,{label:"名稱",modelValue:o.value.name,"onUpdate:modelValue":n[0]||(n[0]=a=>o.value.name=a),rules:[A(z)],autofocus:""},null,8,["modelValue","rules"]),l(x,null,{default:i(()=>[l(b,null,{default:i(()=>[l(M,null,{default:i(()=>[...n[1]||(n[1]=[V("功能",-1)])]),_:1}),l(J,{ref_key:"functions",ref:p,onChange:e,class:"mt-2"},null,512)]),_:1})]),_:1})]),_:1},512)],64))}};export{ne as default};
