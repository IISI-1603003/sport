import{f as u,h as C,E as c,b as k,o as j,G as T,j as B,w as s,e as l,k as E,m as V,t as F,H as S,F as I,B as P,u as A}from"./index-DqmTDoDs.js";import{V as O}from"./VForm-BCuC86hi.js";import{V as x,a as U,b as q,c as D,d as y}from"./VCard-CgHR1yKO.js";import{V as b}from"./VSpacer-DEGOIKRM.js";import{V as w}from"./VBtn-piz4QD9w.js";import{V as M}from"./VDialog-1KMYd9pd.js";import{r as N}from"./rules-CItqinxz.js";import{V as G}from"./VToolbar-DYAOBvwY.js";import{V as H,a as L}from"./VTextField-DAyEXajC.js";import"./index-DqUa_ESF.js";import"./forwardRefs-hYDfs0pe.js";import"./VAvatar-Du42SJ0L.js";import"./index-CVc2CCsc.js";/* empty css              */import"./VOverlay-knTbxnoM.js";import"./scopeId-DMsoizje.js";const z={__name:"tree",emits:["edit"],setup(g,{expose:m,emit:p}){const f=p,i=u(),o=d=>f("edit",d),_=(d,r)=>{let e=$(i.value).jstree(!0),t=e.get_node(d);e.set_text(t,r)};return C(()=>{c.get().then(d=>{$(i.value).jstree({core:{data:d.data,check_callback(r,e,t,n,a){if(r==="delete_node")return confirm("確定要刪除嗎？");if(r==="move_node"&&!a.dnd)return confirm("確定要移動嗎？")},themes:{name:"default"}},plugins:["types","contextmenu","dnd"],types:{"#":{valid_children:["root"]},root:{valid_children:["role"]},role:{valid_children:["role"],icon:"mdi mdi-account-group text-warning"}},contextmenu:{items:function(r){var e=$.jstree.defaults.contextmenu.items();return e.create.label="新增",e.rename.label="重新命名",e.remove.label="移除",e.create.action=t=>{var n=$.jstree.reference(t.reference),a=n.get_node(t.reference);n.create_node(a,{type:"role"},"last")},e.edit={label:"設定",separator_before:!0,action(t){var n=$.jstree.reference(t.reference),a=n.get_node(t.reference);o(a.id)}},this.get_type(r)==="root"&&(delete e.rename,delete e.remove,delete e.edit),delete e.ccp,e}}}).on("create_node.jstree",(r,e)=>{let t=e.instance.get_node(e.node.parent);c.save({name:e.node.text,parentId:t.original.id,sequence:e.position}).then(n=>{e.node.original.id=n.data.id,e.instance.set_id(e.node,n.data.id),e.instance.edit(e.node)})}).on("rename_node.jstree",(r,e)=>{c.rename({id:e.node.id},{name:e.text})}).on("delete_node.jstree",(r,e)=>{c.delete({id:e.node.id})}).on("move_node.jstree",function(r,e){var t=e.instance.get_node(e.parent),n=e.instance.get_node(e.old_parent);c.move({id:e.node.id,parentId:t.original.id,position:e.position,oldParentId:n.original.id,oldPosition:e.old_position})})})}),m({rename:_}),(d,r)=>(j(),k("div",{ref_key:"root",ref:i},null,512))}},J={__name:"functions",emits:["change"],setup(g,{expose:m,emit:p}){const f=p,i=u([]),o=u(),_=()=>{$(o.value).jstree("close_all"),$(o.value).jstree("deselect_all")},d=e=>i.value=e,r=e=>{let t=[],n=[],a=[],h=[];e.forEach(v=>{switch(v.type){case"menu":t.push(v.id);break;case"page":n.push(v.id);break;case"operation":a.push(v.id);break;case"api":h.push(v.id);break}}),f("change",{menus:t,pages:n,operations:a,apis:h})};return C(()=>{c.functions().then(e=>{$(o.value).jstree({plugins:["types","checkbox"],core:{data:e.data,themes:{name:"default"}},sort:function(t,n){let a={menu:1,page:2,api:3};return a[this.get_type(t)]>a[this.get_type(n)]?1:-1},types:{"#":{valid_children:["menu"]},menu:{valid_children:["menu","page"],icon:"mdi mdi-folder text-warning"},page:{valid_children:["page","operation","api"],icon:"mdi mdi-file text-primary"},operation:{valid_children:["api"],icon:"mdi mdi-cog text-success"},api:{valid_children:[],icon:"mdi mdi-link text-red"}}}).on("ready.jstree",(t,n)=>{let a=n.instance.get_checked(!0);r(a);let h=$(o.value).jstree(!0);i.value.forEach(v=>{h.select_node(v)})}).on("select_node.jstree deselect_node.jstree",(t,n)=>{let a=n.instance.get_checked(!0);r(a)})})}),m({deselectAll:_,selection:d}),(e,t)=>(j(),k("div",{ref_key:"root",ref:o},null,512))}},K={__name:"popup",props:["title"],emits:["submit"],setup(g,{expose:m,emit:p}){const f=p,i=u(!1),o=u(null),_=()=>i.value=!0,d=()=>i.value=!1,r=()=>{o.value&&f("submit")};return T(o,e=>f("update:valid",e)),m({show:_,hide:d}),(e,t)=>(j(),B(M,{modelValue:i.value,"onUpdate:modelValue":t[2]||(t[2]=n=>i.value=n),width:"600",persistent:"",scrollable:""},{default:s(()=>[l(O,{onSubmit:E(r,["prevent"]),modelValue:o.value,"onUpdate:modelValue":t[1]||(t[1]=n=>o.value=n)},{default:s(()=>[l(x,{"max-height":"90vh"},{default:s(()=>[l(U,null,{default:s(()=>[V(F(g.title),1)]),_:1}),l(q,null,{default:s(()=>[S(e.$slots,"default")]),_:3}),l(D,null,{default:s(()=>[l(b),l(w,{type:"submit",color:"primary"},{default:s(()=>[...t[3]||(t[3]=[V("確定",-1)])]),_:1}),l(w,{onClick:t[0]||(t[0]=n=>i.value=!1)},{default:s(()=>[...t[4]||(t[4]=[V("取消",-1)])]),_:1}),l(b)]),_:1})]),_:3})]),_:3},8,["modelValue"])]),_:3},8,["modelValue"]))}},ue={__name:"index",setup(g){const m=u(null),p=u(null),f=u(null),i=P("menu"),o=u({id:null,name:null}),_=u({menus:[],pages:[],operations:[],apis:[]}),d=t=>{Promise.all([c.get({id:t}),c.functions({id:t})]).then(([n,a])=>{Object.assign(o.value,n.data),Object.assign(_.value,a.data),m.value.show(),setTimeout(()=>{p.value.deselectAll(),p.value.selection([...a.data.menus,...a.data.pages,...a.data.operations,...a.data.apis])})})},r=()=>{c.update({id:o.value.id},o.value).then(()=>{c.updateFunctions({id:o.value.id},_.value).then(()=>{m.value.hide(),f.value.rename(o.value.id,o.value.name),i.value.load(!0)})})},e=t=>{Object.assign(_.value,t)};return(t,n)=>(j(),k(I,null,[l(x,null,{default:s(()=>[l(G,{title:t.$root.subTitle},null,8,["title"]),l(y,null,{default:s(()=>[l(z,{ref_key:"tree",ref:f,onEdit:d},null,512)]),_:1})]),_:1}),l(K,{ref_key:"popup",ref:m,title:"角色設定",onSubmit:r},{default:s(()=>[l(H,{label:"名稱",modelValue:o.value.name,"onUpdate:modelValue":n[0]||(n[0]=a=>o.value.name=a),rules:[A(N)],autofocus:""},null,8,["modelValue","rules"]),l(x,null,{default:s(()=>[l(y,null,{default:s(()=>[l(L,null,{default:s(()=>[...n[1]||(n[1]=[V("功能",-1)])]),_:1}),l(J,{ref_key:"functions",ref:p,onChange:e,class:"mt-2"},null,512)]),_:1})]),_:1})]),_:1},512)],64))}};export{ue as default};
