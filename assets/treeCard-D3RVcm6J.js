import{d as m,e as y,z as u,c as k,o as x,K as C,h as w,w as r,b as a,i as T,k as v,x as F,L as S,m as j,F as B,H as I,q as P,u as q,M}from"./index-BxuKpZ1b.js";import{_ as O}from"./functions-DcEDabBx.js";import{V as U}from"./VForm-BYMSUQox.js";import{V,a as A,b as D,c as E,d as h}from"./VCard-TkA4NB2g.js";import{V as b}from"./VSpacer-DH6S88JW.js";import{V as L}from"./VDialog-B11mrxhi.js";import{r as N}from"./rules-Bm4BX98a.js";import{V as z}from"./VToolbar-Btrh3Csj.js";/* empty css              */const H={__name:"tree",emits:["edit"],setup(g,{expose:c,emit:p}){const f=p,i=m(),o=d=>f("edit",d),_=(d,l)=>{let e=$(i.value).jstree(!0),t=e.get_node(d);e.set_text(t,l)};return y(()=>{u.get().then(d=>{$(i.value).jstree({core:{data:d.data,check_callback(l,e,t,n,s){if(l==="delete_node")return confirm("確定要刪除嗎？");if(l==="move_node"&&!s.dnd)return confirm("確定要移動嗎？")},themes:{name:"default"}},plugins:["types","contextmenu","dnd"],types:{"#":{valid_children:["root"]},root:{valid_children:["role"]},role:{valid_children:["role"],icon:"mdi mdi-account-group text-warning"}},contextmenu:{items:function(l){var e=$.jstree.defaults.contextmenu.items();return e.create.label="新增",e.rename.label="重新命名",e.remove.label="移除",e.create.action=t=>{var n=$.jstree.reference(t.reference),s=n.get_node(t.reference);n.create_node(s,{type:"role"},"last")},e.edit={label:"設定",separator_before:!0,action(t){var n=$.jstree.reference(t.reference),s=n.get_node(t.reference);o(s.id)}},this.get_type(l)==="root"&&(delete e.rename,delete e.remove,delete e.edit),delete e.ccp,e}}}).on("create_node.jstree",(l,e)=>{let t=e.instance.get_node(e.node.parent);u.save({name:e.node.text,parentId:t.original.id,sequence:e.position}).then(n=>{e.node.original.id=n.data.id,e.instance.set_id(e.node,n.data.id),e.instance.edit(e.node)})}).on("rename_node.jstree",(l,e)=>{u.rename({id:e.node.id},{name:e.text})}).on("delete_node.jstree",(l,e)=>{u.delete({id:e.node.id})}).on("move_node.jstree",function(l,e){var t=e.instance.get_node(e.parent),n=e.instance.get_node(e.old_parent);u.move({id:e.node.id,parentId:t.original.id,position:e.position,oldParentId:n.original.id,oldPosition:e.old_position})})})}),c({rename:_}),(d,l)=>(x(),k("div",{ref_key:"root",ref:i},null,512))}},K={__name:"popup",props:["title"],emits:["submit"],setup(g,{expose:c,emit:p}){const f=p,i=m(!1),o=m(null),_=()=>i.value=!0,d=()=>i.value=!1,l=()=>{o.value&&f("submit")};return C(o,e=>f("update:valid",e)),c({show:_,hide:d}),(e,t)=>(x(),w(L,{modelValue:i.value,"onUpdate:modelValue":t[2]||(t[2]=n=>i.value=n),width:"600",persistent:"",scrollable:""},{default:r(()=>[a(U,{onSubmit:T(l,["prevent"]),modelValue:o.value,"onUpdate:modelValue":t[1]||(t[1]=n=>o.value=n)},{default:r(()=>[a(V,{"max-height":"90vh"},{default:r(()=>[a(A,null,{default:r(()=>[v(F(g.title),1)]),_:1}),a(D,null,{default:r(()=>[S(e.$slots,"default")]),_:3}),a(E,null,{default:r(()=>[a(b),a(j,{type:"submit",color:"primary"},{default:r(()=>[...t[3]||(t[3]=[v("確定",-1)])]),_:1}),a(j,{onClick:t[0]||(t[0]=n=>i.value=!1)},{default:r(()=>[...t[4]||(t[4]=[v("取消",-1)])]),_:1}),a(b)]),_:1})]),_:3})]),_:3},8,["modelValue"])]),_:3},8,["modelValue"]))}},te={__name:"treeCard",setup(g){const c=m(null),p=m(null),f=m(null),i=I("menu"),o=m({id:null,name:null}),_=m({menus:[],pages:[],operations:[],apis:[]}),d=t=>{Promise.all([u.get({id:t}),u.functions({id:t})]).then(([n,s])=>{Object.assign(o.value,n.data),Object.assign(_.value,s.data),c.value.show(),setTimeout(()=>{p.value.deselectAll(),p.value.selection([...s.data.menus,...s.data.pages,...s.data.operations,...s.data.apis])})})},l=()=>{u.update({id:o.value.id},o.value).then(()=>{u.updateFunctions({id:o.value.id},_.value).then(()=>{c.value.hide(),f.value.rename(o.value.id,o.value.name),i.value.load(!0)})})},e=t=>{Object.assign(_.value,t)};return(t,n)=>(x(),k(B,null,[a(V,null,{default:r(()=>[a(z,{title:t.$root.subTitle},null,8,["title"]),a(h,null,{default:r(()=>[a(H,{ref_key:"tree",ref:f,onEdit:d},null,512)]),_:1})]),_:1}),a(K,{ref_key:"popup",ref:c,title:"角色設定",onSubmit:l},{default:r(()=>[a(P,{label:"名稱",modelValue:o.value.name,"onUpdate:modelValue":n[0]||(n[0]=s=>o.value.name=s),rules:[q(N)],autofocus:""},null,8,["modelValue","rules"]),a(V,null,{default:r(()=>[a(h,null,{default:r(()=>[a(M,null,{default:r(()=>[...n[1]||(n[1]=[v("功能",-1)])]),_:1}),a(O,{ref_key:"functions",ref:p,onChange:e,class:"mt-2"},null,512)]),_:1})]),_:1})]),_:1},512)],64))}};export{te as default};
