import{x as U,h as B,b as q,o as H}from"./index-DqmTDoDs.js";var w={},_={},I;function Y(){return I||(I=1,Object.defineProperty(_,"__esModule",{value:!0}),_.IFRAME_COMMS_MESSAGE_TYPE=_.DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY=void 0,_.IFRAME_COMMS_MESSAGE_TYPE="__embedded_comms__",_.DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY={visible:"show_filters",expanded:"expand_filters"}),_}var f=(function(t){return t.GET="get",t.REPLY="reply",t.EMIT="emit",t.ERROR="error",t})(f||{});function z(t){return t.switchboardAction===f.GET}function K(t){return t.switchboardAction===f.REPLY}function W(t){return t.switchboardAction===f.EMIT}function J(t){return t.switchboardAction===f.ERROR}class P{constructor(s){this.port=void 0,this.name="",this.methods={},this.incrementor=1,this.debugMode=void 0,this.isInitialised=void 0,s&&this.init(s)}init(s){if(this.isInitialised){this.logError("already initialized");return}const{port:o,name:i="switchboard",debug:r=!1}=s;this.port=o,this.name=i,this.debugMode=r,o.addEventListener("message",async e=>{this.log("message received",e);const n=e.data;if(z(n))this.port.postMessage(await this.getMethodResult(n));else if(W(n)){const{method:a,args:u}=n,c=this.methods[a];c&&c(u)}}),this.isInitialised=!0}async getMethodResult({messageId:s,method:o,args:i}){const r=this.methods[o];if(r==null)return{switchboardAction:f.ERROR,messageId:s,error:`[${this.name}] Method "${o}" is not defined`};try{const e=await r(i);return{switchboardAction:f.REPLY,messageId:s,result:e}}catch(e){return this.logError(e),{switchboardAction:f.ERROR,messageId:s,error:`[${this.name}] Method "${o}" threw an error`}}}defineMethod(s,o){this.methods[s]=o}get(s,o=void 0){return new Promise((i,r)=>{if(!this.isInitialised){r(new Error("Switchboard not initialised"));return}const e=this.getNewMessageId(),n=u=>{const c=u.data;if(c.messageId===e)if(this.port.removeEventListener("message",n),K(c))i(c.result);else{const E=J(c)?c.error:"Unexpected response message";r(new Error(E))}};this.port.addEventListener("message",n),this.port.start();const a={switchboardAction:f.GET,method:s,messageId:e,args:o};this.port.postMessage(a)})}emit(s,o=void 0){if(!this.isInitialised){this.logError("Switchboard not initialised");return}const i={switchboardAction:f.EMIT,method:s,args:o};this.port.postMessage(i)}start(){if(!this.isInitialised){this.logError("Switchboard not initialised");return}this.port.start()}log(...s){this.debugMode&&console.debug(`[${this.name}]`,...s)}logError(...s){console.error(`[${this.name}]`,...s)}getNewMessageId(){return`m_${this.name}_${this.incrementor++}`}}const X=new P,V=Object.freeze(Object.defineProperty({__proto__:null,Switchboard:P,default:X},Symbol.toStringTag,{value:"Module"})),Q=U(V);var h={},b={},y;function Z(){if(y)return b;y=1,Object.defineProperty(b,"__esModule",{value:!0}),b.jwtDecode=b.InvalidTokenError=void 0;class t extends Error{}b.InvalidTokenError=t,t.prototype.name="InvalidTokenError";function s(r){return decodeURIComponent(atob(r).replace(/(.)/g,(e,n)=>{let a=n.charCodeAt(0).toString(16).toUpperCase();return a.length<2&&(a="0"+a),"%"+a}))}function o(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return s(e)}catch{return atob(e)}}function i(r,e){if(typeof r!="string")throw new t("Invalid token specified: must be a string");e||(e={});const n=e.header===!0?0:1,a=r.split(".")[n];if(typeof a!="string")throw new t(`Invalid token specified: missing part #${n+1}`);let u;try{u=o(a)}catch(c){throw new t(`Invalid token specified: invalid base64 for part #${n+1} (${c.message})`)}try{return JSON.parse(u)}catch(c){throw new t(`Invalid token specified: invalid json for part #${n+1} (${c.message})`)}}return b.jwtDecode=i,b}var A;function ee(){if(A)return h;A=1,Object.defineProperty(h,"__esModule",{value:!0}),h.REFRESH_TIMING_BUFFER_MS=h.MIN_REFRESH_WAIT_MS=h.DEFAULT_TOKEN_EXP_MS=void 0,h.getGuestTokenRefreshTiming=r;var t=Z();const s=h.REFRESH_TIMING_BUFFER_MS=5e3,o=h.MIN_REFRESH_WAIT_MS=1e4,i=h.DEFAULT_TOKEN_EXP_MS=3e5;function r(e){const n=(0,t.jwtDecode)(e),a=new Date(/[^0-9\.]/g.test(n.exp)?n.exp:parseFloat(n.exp)*1e3);return(a.toString()!=="Invalid Date"?Math.max(o,a.getTime()-Date.now()):i)-s}return h}var D;function te(){if(D)return w;D=1,Object.defineProperty(w,"__esModule",{value:!0}),w.embedDashboard=i;var t=Y(),s=Q,o=ee();async function i({id:r,supersetDomain:e,mountPoint:n,fetchGuestToken:a,dashboardUiConfig:u,debug:c=!1,iframeTitle:E="Embedded Dashboard",iframeSandboxExtras:T=[],referrerPolicy:R}){function m(...d){c&&console.debug(`[superset-embedded-sdk][dashboard ${r}]`,...d)}m("embedding"),e.endsWith("/")&&(e=e.slice(0,-1));function O(){let d=0;return u&&(u.hideTitle&&(d+=1),u.hideTab&&(d+=2),u.hideChartControls&&(d+=8),u.emitDataMasks&&(d+=16)),d}async function x(){return new Promise(d=>{const l=document.createElement("iframe"),C=u?{uiConfig:`${O()}`}:void 0,S=u?.filters||{},$=Object.keys(S),j=Object.fromEntries($.map(p=>[t.DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY[p],S[p]])),k={...C,...j,...u?.urlParams},G=Object.keys(k).length?"?"+new URLSearchParams(k).toString():"";l.sandbox.add("allow-same-origin"),l.sandbox.add("allow-scripts"),l.sandbox.add("allow-presentation"),l.sandbox.add("allow-downloads"),l.sandbox.add("allow-forms"),l.sandbox.add("allow-popups"),T.forEach(p=>{l.sandbox.add(p)}),R&&(l.referrerPolicy=R),l.addEventListener("load",()=>{const p=new MessageChannel,L=p.port1,N=p.port2;l.contentWindow.postMessage({type:t.IFRAME_COMMS_MESSAGE_TYPE,handshake:"port transfer"},e,[N]),m("sent message channel to the iframe"),d(new s.Switchboard({port:L,name:"superset-embedded-sdk",debug:c}))}),l.src=`${e}/embedded/${r}${G}`,l.title=E,n.replaceChildren(l),m("placed the iframe")})}const[M,g]=await Promise.all([a(),x()]);g.emit("guestToken",{guestToken:M}),m("sent guest token");async function v(){const d=await a();g.emit("guestToken",{guestToken:d}),setTimeout(v,(0,o.getGuestTokenRefreshTiming)(d))}setTimeout(v,(0,o.getGuestTokenRefreshTiming)(M));function F(){m("unmounting"),n.replaceChildren()}return{getScrollSize:()=>g.get("getScrollSize"),unmount:F,getDashboardPermalink:d=>g.get("getDashboardPermalink",{anchor:d}),getActiveTabs:()=>g.get("getActiveTabs"),observeDataMask:d=>{g.start(),g.defineMethod("observeDataMask",d)},getDataMask:()=>g.get("getDataMask"),setThemeConfig:async d=>{try{g.emit("setThemeConfig",{themeConfig:d}),m("Theme config sent successfully (or at least message dispatched)")}catch(l){throw m('Error sending theme config. Ensure the iframe side implements the "setThemeConfig" method.'),l}}}}return w}var se=te();const re={id:"superset-dashboard"},le={__name:"superset",setup(t){B(()=>{o("01565347-bc25-4986-bcaf-29cc1e0b5ef3")});const s=async i=>{try{const n=(await(await fetch("/superset/api/v1/security/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:"admin",password:"admin",provider:"db",refresh:!0})})).json()).access_token,c=(await(await fetch("/superset/api/v1/security/csrf_token/",{headers:{Authorization:`Bearer ${n}`}})).json()).result;return(await(await fetch("/superset/api/v1/security/guest_token/",{method:"POST",headers:{"X-CSRFToken":c,"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({resources:[{type:"dashboard",id:i}],rls:[{clause:"Times<1000"}],user:{username:"user_456",first_name:"Allen",last_name:"Chen"}})})).json()).token}catch(r){throw console.error("取得 token 失敗:",r),r}},o=i=>{se.embedDashboard({id:i,supersetDomain:"http://localhost:8088",mountPoint:document.getElementById("superset-dashboard"),fetchGuestToken:()=>s(i),dashboardUiConfig:{hideTitle:!0,filters:{expanded:!0},urlParams:{foo:"value1",bar:"value2"}},iframeSandboxExtras:["allow-top-navigation","allow-popups-to-escape-sandbox"]})};return(i,r)=>(H(),q("div",re))}};export{le as default};
