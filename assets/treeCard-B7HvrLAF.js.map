{"version":3,"file":"treeCard-B7HvrLAF.js","sources":["../../src/views/roles/tree.vue","../../src/components/popup.vue","../../src/views/roles/treeCard.vue"],"sourcesContent":["<template>\r\n  <div ref=\"root\"></div>\r\n</template>\r\n\r\n<script setup>\r\nimport { roles } from \"@/requests\";\r\nimport { ref, onMounted } from \"vue\";\r\nconst emit = defineEmits(['edit'])\r\nconst root = ref()\r\nconst edit = (id) => emit('edit', id)\r\nconst rename = (id, name) => {\r\n  let inst = $(root.value).jstree(true);\r\n  let node = inst.get_node(id);\r\n  inst.set_text(node, name);\r\n}\r\nonMounted(() => {\r\n  roles.get().then(a => {\r\n    $(root.value)\r\n      .jstree({\r\n        core: {\r\n          data: a.data,\r\n          check_callback(operation, node, node_parent, node_position, more) {\r\n            if (operation === \"delete_node\") return confirm(\"確定要刪除嗎？\");\r\n            if (operation === \"move_node\" && !more.dnd)\r\n              return confirm(\"確定要移動嗎？\");\r\n          },\r\n          themes: {\r\n            name: \"default\",\r\n          }\r\n        },\r\n        plugins: [\"types\", \"contextmenu\", \"dnd\"],\r\n        types: {\r\n          \"#\": {\r\n            valid_children: [\"root\"]\r\n          },\r\n          root: {\r\n            valid_children: [\"role\"]\r\n          },\r\n          role: {\r\n            valid_children: [\"role\"],\r\n            icon: \"mdi mdi-account-group text-warning\"\r\n          }\r\n        },\r\n        contextmenu: {\r\n          items: function (node) {\r\n            var tmp = $.jstree.defaults.contextmenu.items();\r\n            tmp.create.label = \"新增\";\r\n            tmp.rename.label = \"重新命名\";\r\n            tmp.remove.label = \"移除\";\r\n            tmp.create.action = data => {\r\n              var inst = $.jstree.reference(data.reference),\r\n                obj = inst.get_node(data.reference);\r\n              inst.create_node(obj, { type: \"role\" }, \"last\");\r\n            };\r\n            tmp.edit = {\r\n              label: \"設定\",\r\n              separator_before: true,\r\n              action(data) {\r\n                var inst = $.jstree.reference(data.reference),\r\n                  obj = inst.get_node(data.reference);\r\n                edit(obj.id);\r\n              }\r\n            };\r\n            if (this.get_type(node) === \"root\") {\r\n              delete tmp.rename;\r\n              delete tmp.remove;\r\n              delete tmp.edit;\r\n            }\r\n            delete tmp.ccp;\r\n            return tmp;\r\n          }\r\n        }\r\n      })\r\n      .on(\"create_node.jstree\", (a, b) => {\r\n        let parent = b.instance.get_node(b.node.parent);\r\n        roles\r\n          .save({\r\n            name: b.node.text,\r\n            parentId: parent.original.id,\r\n            sequence: b.position\r\n          })\r\n          .then(a => {\r\n            b.node.original.id = a.data.id;\r\n            b.instance.set_id(b.node, a.data.id);\r\n            b.instance.edit(b.node);\r\n          });\r\n      })\r\n      .on(\"rename_node.jstree\", (a, b) => {\r\n        roles.rename({ id: b.node.id }, { name: b.text });\r\n      })\r\n      .on(\"delete_node.jstree\", (a, b) => {\r\n        roles.delete({ id: b.node.id });\r\n      })\r\n      .on(\"move_node.jstree\", function (e, data) {\r\n        var parent = data.instance.get_node(data.parent);\r\n        var oldParent = data.instance.get_node(data.old_parent);\r\n        roles.move({\r\n          id: data.node.id,\r\n          parentId: parent.original.id,\r\n          position: data.position,\r\n          oldParentId: oldParent.original.id,\r\n          oldPosition: data.old_position\r\n        });\r\n      });\r\n  });\r\n})\r\ndefineExpose({ rename })\r\n</script>\r\n\r\n","<template>\r\n  <v-dialog v-model=\"dialog\" width=\"600\" persistent scrollable>\r\n    <v-form @submit.prevent=\"submit\" v-model=\"valid\">\r\n      <v-card max-height=\"90vh\">\r\n        <v-card-title>{{ title }}</v-card-title>\r\n        <v-card-text>\r\n          <slot></slot>\r\n        </v-card-text>\r\n        <v-card-actions>\r\n          <v-spacer></v-spacer>\r\n          <v-btn type=\"submit\" color=\"primary\">確定</v-btn>\r\n          <v-btn @click=\"dialog=false\">取消</v-btn>\r\n          <v-spacer></v-spacer>\r\n        </v-card-actions>\r\n      </v-card>\r\n    </v-form>\r\n  </v-dialog>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, watch } from 'vue'\r\ndefineProps(['title'])\r\nconst emit = defineEmits(['submit'])\r\nconst dialog = ref(false)\r\nconst valid = ref(null)\r\nconst show = () => dialog.value = true\r\nconst hide = () => dialog.value = false\r\nconst submit = () => {\r\n  if (!valid.value) return;\r\n  emit('submit')\r\n}\r\nwatch(valid, a => emit('update:valid', a))\r\ndefineExpose({ show, hide })\r\n</script>\r\n","<template>\r\n  <v-card>\r\n    <v-toolbar :title=\"$root.subTitle\"></v-toolbar>\r\n    <v-card-item>\r\n      <tree ref=\"tree\" @edit=\"edit\"></tree>\r\n    </v-card-item>\r\n  </v-card>\r\n  <popup ref=\"popup\" title=\"角色設定\" @submit=\"submit\">\r\n    <v-text-field label=\"名稱\" v-model=\"form.name\" :rules=\"[required]\" autofocus />\r\n    <v-card>\r\n      <v-card-item>\r\n        <v-label>功能</v-label>\r\n        <functions ref=\"functions\" @change=\"change\" class=\"mt-2\" />\r\n      </v-card-item>\r\n    </v-card>\r\n  </popup>\r\n</template>\r\n\r\n<script setup>\r\nimport Tree from \"./tree.vue\";\r\nimport Functions from \"./functions.vue\";\r\nimport Popup from \"@/components/popup.vue\";\r\nimport { roles } from \"@/requests\";\r\nimport { ref, inject } from \"vue\";\r\nimport { required } from \"@/rules\";\r\n\r\nconst popup = ref(null);\r\nconst functions = ref(null);\r\nconst tree = ref(null);\r\nconst menu = inject('menu')\r\nconst form = ref({\r\n  id: null,\r\n  name: null,\r\n})\r\nconst func = ref({\r\n  menus: [],\r\n  pages: [],\r\n  operations: [],\r\n  apis: [],\r\n})\r\n\r\nconst edit = (id) => {\r\n  Promise.all([roles.get({ id: id }), roles.functions({ id: id })]).then(([a, b]) => {\r\n    Object.assign(form.value, a.data);\r\n    Object.assign(func.value, b.data);\r\n    popup.value.show();\r\n    setTimeout(() => {\r\n      functions.value.deselectAll();\r\n      functions.value.selection([...b.data.menus, ...b.data.pages, ...b.data.operations, ...b.data.apis]);\r\n    });\r\n  });\r\n}\r\n\r\nconst submit = () => {\r\n  roles.update({ id: form.value.id }, form.value).then(() => {\r\n    roles.updateFunctions({ id: form.value.id }, func.value).then(() => {\r\n      popup.value.hide();\r\n      tree.value.rename(form.value.id, form.value.name);\r\n      menu.value.load(true);\r\n    });\r\n  });\r\n}\r\n\r\nconst change = (list) => {\r\n  Object.assign(func.value, list);\r\n}\r\n</script>\r\n"],"names":["emit","__emit","root","ref","edit","id","rename","name","inst","node","onMounted","roles","a","operation","node_parent","node_position","more","tmp","data","obj","b","parent","e","oldParent","__expose","_createElementBlock","dialog","valid","show","hide","submit","watch","_createBlock","_component_v_dialog","$event","_createVNode","_component_v_form","_component_v_card","_component_v_card_title","__props","_component_v_card_text","_renderSlot","_ctx","_component_v_card_actions","_component_v_spacer","_component_v_btn","_cache","popup","functions","tree","menu","inject","form","func","change","list","_component_v_toolbar","$root","_component_v_card_item","Tree","Popup","_component_v_text_field","_unref","required","_component_v_label","Functions"],"mappings":"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"}