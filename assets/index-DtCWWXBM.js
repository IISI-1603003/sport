import{d as _,n as T,an as h,c as k,o as y,s as C,x as A,y as B,ao as D,a0 as I,a1 as j,O as L,P as b,b as s,a2 as O,e as U,w as m,f as R,i as x,t as W,ap as M,F as N,W as q,u as H}from"./index-BnWGZjZU.js";import{V as z}from"./VForm-CIrmTTQG.js";import{V as E,b as G,c as J,d as K,a as P}from"./VCard-zUhJ9I50.js";import{e as Q,c as X}from"./VToolbar-BfEJDGNV.js";import{f as Y,V as w}from"./forwardRefs-D9cDfZWG.js";import{u as Z,a as S,m as ee,V as te}from"./VOverlay-WHk44C88.js";import{u as ne,s as ae}from"./index-Qwe4pdWv.js";import{a as oe,V as le}from"./VTextField-DYN48Fc6.js";import"./form-BnPftLth.js";const re={__name:"tree",emits:["edit"],setup(o,{expose:g,emit:v}){const p=v,u=_(),l=d=>p("edit",d),r=(d,i)=>{let e=$(u.value).jstree(!0),t=e.get_node(d);e.set_text(t,i)};return T(()=>{h.get().then(d=>{$(u.value).jstree({core:{data:d.data,check_callback(i,e,t,n,a){if(i==="delete_node")return confirm("確定要刪除嗎？");if(i==="move_node"&&!a.dnd)return confirm("確定要移動嗎？")},themes:{name:"default"}},plugins:["types","contextmenu","dnd"],types:{"#":{valid_children:["root"]},root:{valid_children:["role"]},role:{valid_children:["role"],icon:"mdi mdi-account-group text-warning"}},contextmenu:{items:function(i){var e=$.jstree.defaults.contextmenu.items();return e.create.label="新增",e.rename.label="重新命名",e.remove.label="移除",e.create.action=t=>{var n=$.jstree.reference(t.reference),a=n.get_node(t.reference);n.create_node(a,{type:"role"},"last")},e.edit={label:"設定",separator_before:!0,action(t){var n=$.jstree.reference(t.reference),a=n.get_node(t.reference);l(a.id)}},this.get_type(i)==="root"&&(delete e.rename,delete e.remove,delete e.edit),delete e.ccp,e}}}).on("create_node.jstree",(i,e)=>{let t=e.instance.get_node(e.node.parent);h.save({name:e.node.text,parentId:t.original.id,sequence:e.position}).then(n=>{e.node.original.id=n.data.id,e.instance.set_id(e.node,n.data.id),e.instance.edit(e.node)})}).on("rename_node.jstree",(i,e)=>{h.rename({id:e.node.id},{name:e.text})}).on("delete_node.jstree",(i,e)=>{h.delete({id:e.node.id})}).on("move_node.jstree",function(i,e){var t=e.instance.get_node(e.parent),n=e.instance.get_node(e.old_parent);h.move({id:e.node.id,parentId:t.original.id,position:e.position,oldParentId:n.original.id,oldPosition:e.old_position})})})}),g({rename:r}),(d,i)=>(y(),k("div",{ref_key:"root",ref:u},null,512))}},se={__name:"functions",emits:["change"],setup(o,{expose:g,emit:v}){const p=v,u=_([]),l=_(),r=()=>{$(l.value).jstree("close_all"),$(l.value).jstree("deselect_all")},d=e=>u.value=e,i=e=>{let t=[],n=[],a=[],c=[];e.forEach(f=>{switch(f.type){case"menu":t.push(f.id);break;case"page":n.push(f.id);break;case"operation":a.push(f.id);break;case"api":c.push(f.id);break}}),p("change",{menus:t,pages:n,operations:a,apis:c})};return T(()=>{h.functions().then(e=>{$(l.value).jstree({plugins:["types","checkbox"],core:{data:e.data,themes:{name:"default"}},sort:function(t,n){let a={menu:1,page:2,api:3};return a[this.get_type(t)]>a[this.get_type(n)]?1:-1},types:{"#":{valid_children:["menu"]},menu:{valid_children:["menu","page"],icon:"mdi mdi-folder text-warning"},page:{valid_children:["page","operation","api"],icon:"mdi mdi-file text-primary"},operation:{valid_children:["api"],icon:"mdi mdi-cog text-success"},api:{valid_children:[],icon:"mdi mdi-link text-red"}}}).on("ready.jstree",(t,n)=>{let a=n.instance.get_checked(!0);i(a);let c=$(l.value).jstree(!0);u.value.forEach(f=>{c.select_node(f)})}).on("select_node.jstree deselect_node.jstree",(t,n)=>{let a=n.instance.get_checked(!0);i(a)})})}),g({deselectAll:r,selection:d}),(e,t)=>(y(),k("div",{ref_key:"root",ref:l},null,512))}},ie=A({fullscreen:Boolean,retainFocus:{type:Boolean,default:!0},scrollable:Boolean,...ee({origin:"center center",scrollStrategy:"block",transition:{component:te},zIndex:2400})},"VDialog"),ue=C()({name:"VDialog",props:ie(),emits:{"update:modelValue":o=>!0,afterEnter:()=>!0,afterLeave:()=>!0},setup(o,g){let{emit:v,slots:p}=g;const u=B(o,"modelValue"),{scopeId:l}=Z(),r=_();function d(t){const n=t.relatedTarget,a=t.target;if(n!==a&&r.value?.contentEl&&r.value?.globalTop&&![document,r.value.contentEl].includes(a)&&!r.value.contentEl.contains(a)){const c=O(r.value.contentEl);if(!c.length)return;const f=c[0],V=c[c.length-1];n===f?V.focus():f.focus()}}D(()=>{document.removeEventListener("focusin",d)}),I&&j(()=>u.value&&o.retainFocus,t=>{t?document.addEventListener("focusin",d):document.removeEventListener("focusin",d)},{immediate:!0});function i(){v("afterEnter"),(o.scrim||o.retainFocus)&&r.value?.contentEl&&!r.value.contentEl.contains(document.activeElement)&&r.value.contentEl.focus({preventScroll:!0})}function e(){v("afterLeave")}return j(u,async t=>{t||(await L(),r.value.activatorEl?.focus({preventScroll:!0}))}),ne(()=>{const t=S.filterProps(o),n=b({"aria-haspopup":"dialog"},o.activatorProps),a=b({tabindex:-1},o.contentProps);return s(S,b({ref:r,class:["v-dialog",{"v-dialog--fullscreen":o.fullscreen,"v-dialog--scrollable":o.scrollable},o.class],style:o.style},t,{modelValue:u.value,"onUpdate:modelValue":c=>u.value=c,"aria-modal":"true",activatorProps:n,contentProps:a,height:o.fullscreen?void 0:o.height,width:o.fullscreen?void 0:o.width,maxHeight:o.fullscreen?void 0:o.maxHeight,maxWidth:o.fullscreen?void 0:o.maxWidth,role:"dialog",onAfterEnter:i,onAfterLeave:e},l),{activator:p.activator,default:function(){for(var c=arguments.length,f=new Array(c),V=0;V<c;V++)f[V]=arguments[V];return s(ae,{root:"VDialog"},{default:()=>[p.default?.(...f)]})}})}),Y({},r)}}),F=Q("v-spacer","div","VSpacer"),de={__name:"popup",props:["title"],emits:["submit"],setup(o,{expose:g,emit:v}){const p=v,u=_(!1),l=_(null),r=()=>u.value=!0,d=()=>u.value=!1,i=()=>{l.value&&p("submit")};return j(l,e=>p("update:valid",e)),g({show:r,hide:d}),(e,t)=>(y(),U(ue,{modelValue:u.value,"onUpdate:modelValue":t[2]||(t[2]=n=>u.value=n),width:"600",persistent:"",scrollable:""},{default:m(()=>[s(z,{onSubmit:R(i,["prevent"]),modelValue:l.value,"onUpdate:modelValue":t[1]||(t[1]=n=>l.value=n)},{default:m(()=>[s(E,{"max-height":"90vh"},{default:m(()=>[s(G,null,{default:m(()=>[x(W(o.title),1)]),_:1}),s(J,null,{default:m(()=>[M(e.$slots,"default")]),_:3}),s(K,null,{default:m(()=>[s(F),s(w,{type:"submit",color:"primary"},{default:m(()=>[...t[3]||(t[3]=[x("確定",-1)])]),_:1}),s(w,{onClick:t[0]||(t[0]=n=>u.value=!1)},{default:m(()=>[...t[4]||(t[4]=[x("取消",-1)])]),_:1}),s(F)]),_:1})]),_:3})]),_:3},8,["modelValue"])]),_:3},8,["modelValue"]))}},ce=o=>!!o||"必填欄位",ye={__name:"index",setup(o){const g=_(null),v=_(null),p=_(null),u=q("menu"),l=_({id:null,name:null}),r=_({menus:[],pages:[],operations:[],apis:[]}),d=t=>{Promise.all([h.get({id:t}),h.functions({id:t})]).then(([n,a])=>{Object.assign(l.value,n.data),Object.assign(r.value,a.data),g.value.show(),setTimeout(()=>{v.value.deselectAll(),v.value.selection([...a.data.menus,...a.data.pages,...a.data.operations,...a.data.apis])})})},i=()=>{h.update({id:l.value.id},l.value).then(()=>{h.updateFunctions({id:l.value.id},r.value).then(()=>{g.value.hide(),p.value.rename(l.value.id,l.value.name),u.value.load(!0)})})},e=t=>{Object.assign(r.value,t)};return(t,n)=>(y(),k(N,null,[s(E,null,{default:m(()=>[s(X,{title:t.$root.subTitle},null,8,["title"]),s(P,null,{default:m(()=>[s(re,{ref_key:"tree",ref:p,onEdit:d},null,512)]),_:1})]),_:1}),s(de,{ref_key:"popup",ref:g,title:"角色設定",onSubmit:i},{default:m(()=>[s(oe,{label:"名稱",modelValue:l.value.name,"onUpdate:modelValue":n[0]||(n[0]=a=>l.value.name=a),rules:[H(ce)],autofocus:""},null,8,["modelValue","rules"]),s(E,null,{default:m(()=>[s(P,null,{default:m(()=>[s(le,null,{default:m(()=>[...n[1]||(n[1]=[x("功能",-1)])]),_:1}),s(se,{ref_key:"functions",ref:v,onChange:e,class:"mt-2"},null,512)]),_:1})]),_:1})]),_:1},512)],64))}};export{ye as default};
