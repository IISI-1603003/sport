import{O as le,C as I,N as we,a3 as Ee,P as Ve,a4 as be,Q as Oe,a5 as ue,d as V,a6 as Ue,a7 as W,K as ne,T as he,U as Ye,W as ce,a8 as de,b as u,A as K,Y as Ce,a9 as Ge,_ as He,a as p,F as O,aa as Ke,ab as We,E as qe,ac as xe,ad as Qe,ae as Ze,af as Je,ag as Xe,ah as et,ai as tt,aj as at,ak as nt,e as Se,al as lt,Z as st,am as ot,an as rt,ao as it,ap as ut,aq as ct,ar as dt,as as ft,G as mt,at as fe,au as vt,av as pt,aw as yt,c as L,w as f,u as b,r as me,n as X,ax as ee,o as D,m as H,k as x,t as N,ay as gt,V as kt,h as wt,s as te}from"./index-LxXqDpAZ.js";import{_ as Vt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as bt,a as ht}from"./VRow-jUgFmOIp.js";import{V as ve}from"./VDialog-N8-sVz9Z.js";import{u as Ct,V as xt}from"./layout-BrqFMtN0.js";import{V as pe,a as ye,b as ae,c as ge}from"./VCard-CFONWuhp.js";import{V as ke}from"./VSpacer-_NgxC0fP.js";/* empty css              */function St(){function e(o){return[...o.dataTransfer?.items??[]].filter(r=>r.kind==="file").map(r=>r.webkitGetAsEntry()).filter(Boolean).length>0||[...o.dataTransfer?.files??[]].length>0}async function c(o){const l=[],r=[...o.dataTransfer?.items??[]].filter(s=>s.kind==="file").map(s=>s.webkitGetAsEntry()).filter(Boolean);if(r.length)for(const s of r){const v=await Te(s,Fe(".",s));l.push(...v.map(d=>d.file))}else l.push(...o.dataTransfer?.files??[]);return l}return{handleDrop:c,hasFilesOrFolders:e}}function Te(e){let c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";return new Promise((o,l)=>{e.isFile?e.file(s=>o([{file:s,path:c}]),l):e.isDirectory&&e.createReader().readEntries(async s=>{const v=[];for(const d of s)v.push(...await Te(d,Fe(c,d)));o(v)})})}function Fe(e,c){return c.isDirectory?`${e}/${c.name}`:e}const Tt=le({filterByType:String},"file-accept");function Ft(e){const c=I(()=>e.filterByType?Pt(e.filterByType):null);function o(l){if(c.value){const r=l.filter(c.value);return{accepted:r,rejected:l.filter(s=>!r.includes(s))}}return{accepted:l,rejected:[]}}return{filterAccepted:o}}function Pt(e){const c=e.split(",").map(s=>s.trim().toLowerCase()),o=c.filter(s=>s.startsWith(".")),l=c.filter(s=>s.endsWith("/*")),r=c.filter(s=>!o.includes(s)&&!l.includes(s));return s=>{const v=s.name.split(".").at(-1)?.toLowerCase()??"",d=s.type.split("/").at(0)?.toLowerCase()??"";return r.includes(s.type)||o.includes(`.${v}`)||l.includes(`${d}/*`)}}const Dt=le({chips:Boolean,counter:Boolean,counterSizeString:{type:String,default:"$vuetify.fileInput.counterSize"},counterString:{type:String,default:"$vuetify.fileInput.counter"},hideInput:Boolean,multiple:Boolean,showSize:{type:[Boolean,Number,String],default:!1,validator:e=>typeof e=="boolean"||[1e3,1024].includes(Number(e))},truncateLength:{type:[Number,String],default:22},...He({prependIcon:"$file"}),modelValue:{type:[Array,Object],default:e=>e.multiple?[]:null,validator:e=>be(e).every(c=>c!=null&&typeof c=="object")},...Tt(),...Ge({clearable:!0})},"VFileInput"),It=we()({name:"VFileInput",inheritAttrs:!1,props:Dt(),emits:{"click:control":e=>!0,"mousedown:control":e=>!0,"update:focused":e=>!0,"update:modelValue":e=>!0,rejected:e=>!0},setup(e,c){let{attrs:o,emit:l,slots:r}=c;const{t:s}=Ee(),{filterAccepted:v}=Ft(e),d=Ve(e,"modelValue",e.modelValue,a=>be(a),a=>!e.multiple&&Array.isArray(a)?a[0]:a),{isFocused:h,focus:_,blur:S}=Oe(e),P=I(()=>typeof e.showSize!="boolean"?e.showSize:void 0),$=I(()=>(d.value??[]).reduce((a,k)=>{let{size:j=0}=k;return a+j},0)),w=I(()=>ue($.value,P.value)),T=I(()=>(d.value??[]).map(a=>{const{name:k="",size:j=0}=a,E=M(k);return e.showSize?`${E} (${ue(j,P.value)})`:E})),z=I(()=>{const a=d.value?.length??0;return e.showSize?s(e.counterSizeString,a,w.value):s(e.counterString,a)}),B=V(),U=V(),y=V(),A=Ue(()=>h.value||e.active),Y=I(()=>["plain","underlined"].includes(e.variant)),R=W(!1),{handleDrop:n,hasFilesOrFolders:t}=St();function g(){y.value!==document.activeElement&&y.value?.focus(),h.value||_()}function C(a){y.value?.click()}function i(a){l("mousedown:control",a)}function m(a){y.value?.click(),l("click:control",a)}function F(a){a.stopPropagation(),g(),xe(()=>{d.value=[],Qe(e["onClick:clear"],a)})}function M(a){if(a.length<Number(e.truncateLength))return a;const k=Math.floor((Number(e.truncateLength)-1)/2);return`${a.slice(0,k)}…${a.slice(a.length-k)}`}function q(a){a.preventDefault(),a.stopImmediatePropagation(),R.value=!0}function Pe(a){a.preventDefault(),R.value=!1}async function De(a){if(a.preventDefault(),a.stopImmediatePropagation(),R.value=!1,!y.value||!t(a))return;const k=await n(a);se(k)}function Ie(a){if(!(!a.target||a.repack))if(e.filterByType)se([...a.target.files]);else{const k=a.target;d.value=[...k.files??[]]}}function se(a){const k=new DataTransfer,{accepted:j,rejected:E}=v(a);E.length&&l("rejected",E);for(const Z of j)k.items.add(Z);y.value.files=k.files,d.value=[...k.files];const Q=new Event("change",{bubbles:!0});Q.repack=!0,y.value.dispatchEvent(Q)}return ne(d,a=>{(!Array.isArray(a)||!a.length)&&y.value&&(y.value.value="")}),he(()=>{const a=!!(r.counter||e.counter),k=!!(a||r.details),[j,E]=Ye(o),{modelValue:Q,...Z}=ce.filterProps(e),_e={...de.filterProps(e),"onClick:clear":F},Be=o.webkitdirectory!==void 0&&o.webkitdirectory!==!1,Ae=o.accept?String(o.accept):void 0,Re=Be?void 0:e.filterByType??Ae;return u(ce,K({ref:B,modelValue:e.multiple?d.value:d.value[0],class:["v-file-input",{"v-file-input--chips":!!e.chips,"v-file-input--dragging":R.value,"v-file-input--hide":e.hideInput,"v-input--plain-underlined":Y.value},e.class],style:e.style,"onClick:prepend":C},j,Z,{centerAffix:!Y.value,focused:h.value}),{...r,default:J=>{let{id:Le,isDisabled:oe,isDirty:re,isReadonly:ie,isValid:Ne,hasDetails:$e}=J;return u(de,K({ref:U,prependIcon:e.prependIcon,onMousedown:i,onClick:m,"onClick:prependInner":e["onClick:prependInner"],"onClick:appendInner":e["onClick:appendInner"]},_e,{id:Le.value,active:A.value||re.value,dirty:re.value||e.dirty,disabled:oe.value,focused:h.value,details:$e.value,error:Ne.value===!1,onDragover:q,onDrop:De}),{...r,default:ze=>{let{props:{class:Me,...je}}=ze;return p(O,null,[p("input",K({ref:y,type:"file",accept:Re,readonly:ie.value,disabled:oe.value,multiple:e.multiple,name:e.name,onClick:G=>{G.stopPropagation(),ie.value&&G.preventDefault(),g()},onChange:Ie,onDragleave:Pe,onFocus:g,onBlur:S},je,E),null),p("div",{class:We(Me)},[!!d.value?.length&&!e.hideInput&&(r.selection?r.selection({fileNames:T.value,totalBytes:$.value,totalBytesReadable:w.value}):e.chips?T.value.map(G=>u(qe,{key:G,size:"small",text:G},null)):T.value.join(", "))])])}})},details:k?J=>p(O,null,[r.details?.(J),a&&p(O,null,[p("span",null,null),u(Ke,{active:!!d.value?.length,value:z.value,disabled:e.disabled},r.counter)])]):void 0})}),Ce({},B,U,y)}});function _t(e){const c=W(e());let o=-1;function l(){clearInterval(o)}function r(){l(),xe(()=>c.value=e())}function s(v){const d=v?getComputedStyle(v):{transitionDuration:.2},h=parseFloat(d.transitionDuration)*1e3||200;if(l(),c.value<=0)return;const _=performance.now();o=window.setInterval(()=>{const S=performance.now()-_+h;c.value=Math.max(e()-S,0),c.value<=0&&l()},h)}return ft(l),{clear:l,time:c,start:s,reset:r}}const Bt=le({multiLine:Boolean,text:String,timer:[Boolean,String],timeout:{type:[Number,String],default:5e3},vertical:Boolean,...ct({location:"bottom"}),...ut(),...it(),...rt(),...ot(),...st(dt({transition:"v-snackbar-transition"}),["persistent","noClickAnimation","scrim","scrollStrategy","stickToTarget"])},"VSnackbar"),At=we()({name:"VSnackbar",props:Bt(),emits:{"update:modelValue":e=>!0},setup(e,c){let{slots:o}=c;const l=Ve(e,"modelValue"),{positionClasses:r}=Ze(e),{scopeId:s}=Je(),{themeClasses:v}=Xe(e),{colorClasses:d,colorStyles:h,variantClasses:_}=et(e),{roundedClasses:S}=tt(e),P=_t(()=>Number(e.timeout)),$=V(),w=V(),T=W(!1),z=W(0),B=V(),U=mt(xt,void 0);at(()=>!!U,()=>{const m=Ct();nt(()=>{B.value=m.mainStyles.value})}),ne(l,A),ne(()=>e.timeout,A),Se(()=>{l.value&&A()});let y=-1;function A(){P.reset(),window.clearTimeout(y);const m=Number(e.timeout);if(!l.value||m===-1)return;const F=lt(w.value);P.start(F),y=window.setTimeout(()=>{l.value=!1},m)}function Y(){P.reset(),window.clearTimeout(y)}function R(){T.value=!0,Y()}function n(){T.value=!1,A()}function t(m){z.value=m.touches[0].clientY}function g(m){Math.abs(z.value-m.changedTouches[0].clientY)>50&&(l.value=!1)}function C(){T.value&&n()}const i=I(()=>e.location.split(" ").reduce((m,F)=>(m[`v-snackbar--${F}`]=!0,m),{}));return he(()=>{const m=fe.filterProps(e),F=!!(o.default||o.text||e.text);return u(fe,K({ref:$,class:["v-snackbar",{"v-snackbar--active":l.value,"v-snackbar--multi-line":e.multiLine&&!e.vertical,"v-snackbar--timer":!!e.timer,"v-snackbar--vertical":e.vertical},i.value,r.value,e.class],style:[B.value,e.style]},m,{modelValue:l.value,"onUpdate:modelValue":M=>l.value=M,contentProps:K({class:["v-snackbar__wrapper",v.value,d.value,S.value,_.value],style:[h.value],onPointerenter:R,onPointerleave:n},m.contentProps),persistent:!0,noClickAnimation:!0,scrim:!1,scrollStrategy:"none",_disableGlobalStack:!0,onTouchstartPassive:t,onTouchend:g,onAfterLeave:C},s),{default:()=>[vt(!1,"v-snackbar"),e.timer&&!T.value&&p("div",{key:"timer",class:"v-snackbar__timer"},[u(pt,{ref:w,color:typeof e.timer=="string"?e.timer:"info",max:e.timeout,modelValue:P.time.value},null)]),F&&p("div",{key:"content",class:"v-snackbar__content",role:"status","aria-live":"polite"},[o.text?.()??e.text,o.default?.()]),o.actions&&u(yt,{defaults:{VBtn:{variant:"text",ripple:!1,slim:!0}}},{default:()=>[p("div",{class:"v-snackbar__actions"},[o.actions({isActive:l})])]})],activator:o.activator})}),Ce({},$)}}),Rt={class:"d-flex align-center"},Lt=["onClick"],Nt={key:1,class:"text-grey"},$t={__name:"fileList",setup(e){const c=V([]),o=V(!1),l=V(!1),r=V([]),s=V(!1),v=V({show:!1,message:"",color:"success"}),d=V(!1),h=V(""),_=V(""),S=V([]),P=[{title:"序號",key:"id",sortable:!0,width:"120px"},{title:"檔案",key:"name",sortable:!0},{title:"處理狀態",key:"status",sortable:!0,width:"140px"},{title:"上傳時間",key:"updateTime",sortable:!0,width:"200px"}],$=I(()=>c.value),w=(n,t="success")=>{v.value={show:!0,message:n,color:t}},T=async()=>{if(!r.value||r.value.length===0){w("請選擇要上傳的檔案","warning");return}let n=r.value[0];if(await R(n)){s.value=!0;try{const g=await ee.uploadFile(n);l.value=!1,r.value=[],w("上傳成功"),setTimeout(async()=>{await z()},1e3)}catch(g){console.error("上傳檔案失敗:",g);const C=g.response?.data?.message||"上傳檔案失敗";w(C,"error")}finally{s.value=!1}}},z=async()=>{o.value=!0;try{const n=await ee.getFiles();c.value=n.data}catch(n){console.error("載入檔案清單失敗:",n),w(message,"error")}finally{o.value=!1}};function B(n){return n?n.split(`
`).map(t=>t.split(",").map(g=>g.trim())):[]}const U=async n=>{try{const t=await ee.getFile(n.name);h.value=t.data.content,_.value=n.name,S.value=B(h.value),d.value=!0}catch(t){console.log(t),w("檔案預覽失敗","error")}};function y(n){if(!n)return"";const t=n.indexOf("-");if(t===-1)return n;const g=n.lastIndexOf(".");return n.substring(0,t)+n.substring(g)}const A=()=>{const n=document.createElement("a");n.href="/files/templateSweatNa.xlsx",n.download="templateSweatNa.xlsx",document.body.appendChild(n),n.click(),document.body.removeChild(n)},Y=n=>new Promise((t,g)=>{const C=new FileReader;C.onload=i=>t(i.target.result),C.onerror=i=>g(i),C.readAsText(n,"UTF-8")}),R=async n=>{if(!(n.type==="text/csv"))return w("請上傳有效的 CSV 檔案","warning"),!1;if(!(n.size<=20*1024*1024))return w("檔案大小不可超過 20MB","warning"),!1;if(!/^.*_\d{8}\.csv$/.test(n.name))return w("檔名必須以_八碼日期結尾","warning"),!1;try{const i=await Y(n);if(!B(i).every(M=>M.every(q=>q.trim()!=="")))return w("CSV內容不能有空白","warning"),!1}catch{return w("讀取檔案內容失敗","error"),!1}return!0};return Se(()=>{z()}),(n,t)=>{const g=me("l-data-table"),C=me("LDataTable");return D(),L(O,null,[u(bt,null,{default:f(()=>[u(ht,{cols:"12",class:"d-flex justify-end mb-2"},{default:f(()=>[u(H,{color:"success","prepend-icon":"mdi-plus",class:"mx-2",onClick:t[0]||(t[0]=i=>l.value=!0)},{default:f(()=>[...t[7]||(t[7]=[x(" 上傳 ",-1)])]),_:1}),u(H,{color:"primary","prepend-icon":"mdi-file-excel",onClick:A},{default:f(()=>[...t[8]||(t[8]=[x(" 範例下載 ",-1)])]),_:1})]),_:1})]),_:1}),u(g,{headers:P,items:b($),loading:b(o)},{"item.id":f(({index:i})=>[x(N(i+1),1)]),"item.name":f(({item:i})=>[p("div",Rt,[u(kt,{class:"me-2",color:"primary"},{default:f(()=>[...t[9]||(t[9]=[x(" mdi-file ",-1)])]),_:1}),p("span",{class:"text-primary cursor-pointer border-b border-primary",onClick:m=>U(i)},N(y(i.name)),9,Lt)])]),"item.status":f(({item:i})=>[x(N(i.status),1)]),"item.updateTime":f(({item:i})=>[x(N(("dayjs"in n?n.dayjs:b(gt))(i.updateTime).format("YYYY-MM-DD HH:mm")),1)]),_:1},8,["items","loading"]),u(ve,{modelValue:b(l),"onUpdate:modelValue":t[3]||(t[3]=i=>X(l)?l.value=i:null),"max-width":"600px"},{default:f(()=>[u(pe,null,{default:f(()=>[u(ye,null,{default:f(()=>[...t[10]||(t[10]=[x("上傳檔案",-1)])]),_:1}),u(ae,null,{default:f(()=>[u(It,{modelValue:b(r),"onUpdate:modelValue":t[1]||(t[1]=i=>X(r)?r.value=i:null),label:"選擇CSV檔案",multiple:"",variant:"outlined",accept:".csv","prepend-icon":"mdi-paperclip"},null,8,["modelValue"])]),_:1}),u(ae,null,{default:f(()=>[...t[11]||(t[11]=[p("ul",{class:"pl-8"},[p("li",null,"檔案上限20MB"),p("li",null,"上傳的檔案註記八碼日期(ex:心理測驗_20230101)"),p("li"),p("li")],-1)])]),_:1}),u(ge,null,{default:f(()=>[u(ke),u(H,{text:"",onClick:t[2]||(t[2]=i=>l.value=!1)},{default:f(()=>[...t[12]||(t[12]=[x("取消",-1)])]),_:1}),u(H,{color:"primary",loading:b(s),onClick:T},{default:f(()=>[...t[13]||(t[13]=[x("上傳",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),u(ve,{modelValue:b(d),"onUpdate:modelValue":t[5]||(t[5]=i=>X(d)?d.value=i:null),"max-width":"1100px"},{default:f(()=>[u(pe,null,{default:f(()=>[u(ye,null,{default:f(()=>[x(N(y(b(_))),1)]),_:1}),u(ae,null,{default:f(()=>[b(S).length?(D(),wt(C,{key:0},{default:f(()=>[p("thead",null,[p("tr",null,[(D(!0),L(O,null,te(b(S)[0],(i,m)=>(D(),L("th",{key:m},N(i),1))),128))])]),p("tbody",null,[(D(!0),L(O,null,te(b(S).slice(1),(i,m)=>(D(),L("tr",{key:m},[(D(!0),L(O,null,te(i,(F,M)=>(D(),L("td",{key:M},N(F),1))),128))]))),128))])]),_:1})):(D(),L("div",Nt,"無資料"))]),_:1}),u(ge,null,{default:f(()=>[u(ke),u(H,{color:"warning",text:"",onClick:t[4]||(t[4]=i=>d.value=!1)},{default:f(()=>[...t[14]||(t[14]=[x("關閉",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),u(At,{modelValue:b(v).show,"onUpdate:modelValue":t[6]||(t[6]=i=>b(v).show=i),color:b(v).color,timeout:3e3},{default:f(()=>[x(N(b(v).message),1)]),_:1},8,["modelValue","color"])],64)}}},Ht=Vt($t,[["__scopeId","data-v-af8ab638"]]);export{Ht as default};
